# Runbook d'Exploitation & Maintenance

## Résumé Exécutif

Ce document fournit les procédures opérationnelles pour l'exploitation et la maintenance de l'application PhotoListing. Il détaille les processus, les outils et les responsabilités nécessaires pour garantir le bon fonctionnement continu de l'application, la gestion des incidents et la planification de la maintenance.

## 1. Vue d'Ensemble de l'Infrastructure

### 1.1 Architecture Générale

L'infrastructure de PhotoListing est composée des éléments suivants:

- **Applications Mobiles**: Applications natives Android et iOS
- **Backend API**: Services REST hébergés sur Google Cloud Run
- **Base de Données**: MongoDB Atlas (cluster distribué)
- **Stockage**: Google Cloud Storage / AWS S3 pour les images
- **CDN**: Cloudflare pour la distribution des assets statiques
- **Services Tiers**: OpenAI API pour le traitement d'images par IA
- **Monitoring**: Firebase Crashlytics, New Relic, Datadog
- **CI/CD**: GitHub Actions, Bitrise

### 1.2 Diagramme d'Architecture

![Architecture PhotoListing](https://via.placeholder.com/800x400?text=Architecture+PhotoListing)

### 1.3 Environnements

| Environnement | Objectif | Accès | Infrastructure |
|---------------|----------|-------|---------------|
| Production | Service client | Utilisateurs | Haute disponibilité, scaling auto |
| Staging | Pré-production | Équipe interne | Miroir de prod à échelle réduite |
| QA | Tests fonctionnels | QA, Dev | Configuration fixe |
| Développement | Développement | Développeurs | Ressources minimales |

## 2. Procédures Opérationnelles Quotidiennes

### 2.1 Checklist Quotidienne

#### Matin (9h00)
- [ ] Vérification des alertes des dernières 12h
- [ ] Contrôle des métriques clés (crash rate, latence API, utilisateurs actifs)
- [ ] Vérification des taux de succès des jobs de traitement d'images
- [ ] Surveillance de la consommation des quotas API OpenAI
- [ ] Contrôle des queues de traitement

#### Après-midi (14h00)
- [ ] Validation des backups
- [ ] Contrôle des taux d'erreur par version d'application
- [ ] Suivi des déploiements en cours
- [ ] Vérification de la santé des services tiers

#### Soir (18h00)
- [ ] Rapport de synthèse des incidents de la journée
- [ ] Vérification des tâches planifiées pour la nuit
- [ ] Transmission des informations à l'astreinte

### 2.2 Dashboards de Surveillance

| Dashboard | URL | Objectif | Alertes | Responsable |
|-----------|-----|----------|---------|-------------|
| Opérations | https://monitor.photolisting.app/ops | Santé globale | Slack #alerts | DevOps |
| Performance | https://monitor.photolisting.app/perf | Latence, charge | Email, Slack | Lead Dev |
| Utilisateurs | https://monitor.photolisting.app/users | Métriques business | Email | Product |
| Sécurité | https://monitor.photolisting.app/security | Vulnérabilités, attaques | SMS, Slack | Security |

### 2.3 Rotation des Clés et Certificats

| Ressource | Fréquence | Procédure | Responsable |
|-----------|-----------|-----------|-------------|
| API Keys OpenAI | 90 jours | [Lien procédure](#) | DevOps |
| JWT Secret | 30 jours | [Lien procédure](#) | Security |
| SSL Certificates | Annuelle (auto) | Renouvellement Let's Encrypt | Automatisé |
| Firebase Service Account | 180 jours | [Lien procédure](#) | Lead Dev |

## 3. Gestion des Incidents

### 3.1 Classification des Incidents

| Niveau | Description | Exemple | Temps de Réponse |
|--------|-------------|---------|------------------|
| P0 | Critique - Service indisponible | App crash global, API down | Immédiat (24/7) |
| P1 | Majeur - Fonction critique impactée | Échec traitement photos | < 1h (heures travail) |
| P2 | Modéré - Fonctionnalité dégradée | Latence élevée, erreurs intermittentes | < 4h (heures travail) |
| P3 | Mineur - Impact limité | UI bugs, problèmes non-bloquants | < 24h (jours ouvrés) |

### 3.2 Processus d'Escalade

```
[Détection] → [Première Réponse] → [Diagnostic] → [Escalade si nécessaire] → [Résolution] → [Post-mortem]
```

#### Matrice d'Escalade

| Niveau | Premier Intervenant | Escalade N+1 | Escalade N+2 | Communication |
|--------|---------------------|--------------|--------------|---------------|
| P0 | On-Call Engineer | Lead Developer | CTO | Tous canaux + Clients |
| P1 | On-Call Engineer | Lead Developer | Product Manager | Slack + Email |
| P2 | Support Technique | On-Call Engineer | Lead Developer | Notification interne |
| P3 | Support Technique | Développeur assigné | - | Ticket interne |

### 3.3 Procédure d'Incident Majeur (P0/P1)

1. **Détection & Alerte**
   - Notification automatique via PagerDuty
   - Création d'un canal Slack #incident-YYYYMMDD-XX

2. **Première Réponse (15 min)**
   - Accusé de réception de l'alerte
   - Évaluation rapide de l'impact
   - Communication initiale aux parties prenantes

3. **Confinement (30 min)**
   - Identification des composants affectés
   - Isolation si possible
   - Mesures de mitigation temporaires

4. **Résolution**
   - Diagnostic approfondi
   - Correctif d'urgence
   - Tests de validation

5. **Rétablissement**
   - Retour à l'état normal
   - Vérification des données et intégrité
   - Communication de fin d'incident

6. **Post-mortem (24-48h)**
   - Analyse de la cause racine
   - Documentation de l'incident
   - Actions correctives et préventives

### 3.4 Modèles de Communication

#### Communication Interne (Slack)
```
:rotating_light: INCIDENT #ID - NIVEAU P0/P1 :rotating_light:

**Statut**: En cours / Résolu
**Impact**: <description concise>
**Composants affectés**: API, BD, Mobile
**Actions en cours**: <description des actions>
**ETA**: HH:MM ou "Indéterminé"
**Responsable**: @username

Nous mettrons à jour ce message toutes les 30 minutes.
```

#### Communication Externe (Utilisateurs)
```
[PhotoListing] Interruption de Service

Chers utilisateurs,

Nous rencontrons actuellement des difficultés techniques affectant [fonctionnalité]. 
Nos équipes sont mobilisées pour résoudre le problème dans les plus brefs délais.

Impact: [description précise]
Durée estimée: [estimation ou "Nous travaillons à déterminer l'ETA"]

Nous vous tiendrons informés de l'évolution de la situation.

L'équipe PhotoListing
```

## 4. Procédures de Maintenance

### 4.1 Maintenance Planifiée

#### Types de Maintenance
- **Mineure**: Sans interruption de service (rolling update)
- **Standard**: Interruption brève (<15 min)
- **Majeure**: Interruption prolongée (>15 min)

#### Planification
- Maintenance mineure: Pendant les heures de travail
- Maintenance standard: 5h00-7h00 UTC (faible trafic)
- Maintenance majeure: Dimanche 2h00-6h00 UTC

#### Notification
- Maintenance mineure: Notification interne uniquement
- Maintenance standard: Notification in-app 24h avant
- Maintenance majeure: Notification in-app, email et réseaux sociaux 72h avant

### 4.2 Procédure de Mise à Jour Backend

1. **Préparation**
   - Vérification des tests automatisés (100% success)
   - Validation des migrations de données
   - Test complet en environnement Staging

2. **Sauvegarde**
   - Snapshot base de données
   - Backup configurations

3. **Déploiement**
   - Annonce de début de maintenance
   - Activation du mode maintenance (page statique)
   - Déploiement avec stratégie Blue/Green
   - Tests smoke post-déploiement

4. **Validation**
   - Vérification des logs d'erreur
   - Validation des métriques de performance
   - Tests fonctionnels critiques

5. **Finalisation**
   - Désactivation du mode maintenance
   - Notification de fin de maintenance
   - Surveillance post-déploiement (2h)

### 4.3 Gestion des Bases de Données

#### Backup Strategy
- **Fréquence**:
  - Snapshots complets: Quotidien (01h00 UTC)
  - Backup incrémental: Toutes les 6 heures
  - Transaction logs: Continu (point-in-time recovery)

- **Rétention**:
  - Snapshots quotidiens: 30 jours
  - Snapshots hebdomadaires: 3 mois
  - Snapshots mensuels: 1 an

#### Procédure de Restauration

1. **Évaluation**
   - Détermination du point de restauration optimal
   - Estimation impact et durée

2. **Préparation**
   - Notification aux utilisateurs
   - Arrêt des services connectés

3. **Restauration**
   - Exécution de la restauration selon le type:
     ```bash
     # Exemple MongoDB Atlas
     mongorestore --uri "mongodb+srv://user:pass@cluster.mongodb.net" --nsInclude "photolisting.*" --drop ./dump-YYYY-MM-DD/
     ```

4. **Validation**
   - Vérification de l'intégrité des données
   - Tests fonctionnels

5. **Reprise**
   - Redémarrage progressif des services
   - Surveillance étroite

### 4.4 Maintenance du Storage

#### Nettoyage des Données Temporaires
```bash
# Supprimer les fichiers temporaires de plus de 7 jours
gsutil -m rm `gsutil ls gs://photolisting-temp/** | grep -v "/\$" | grep "tmp_.*_$(date -d '7 days ago' +%Y%m%d)"`
```

#### Optimisation du Stockage
- Compression des images inutilisées après 30 jours
- Déplacement vers storage froid après 90 jours d'inactivité
- Politique de cycle de vie automatique

## 5. Gestion des Services Tiers

### 5.1 API OpenAI

#### Quotas et Limites
- Budget mensuel: $5,000
- Alertes à 50%, 75%, 90% de consommation
- Répartition: 70% production, 20% staging, 10% développement

#### Procédure en Cas de Dépassement
1. Activation du mode "dégradé" (preprocessing local uniquement)
2. Notification aux utilisateurs premium
3. Throttling des requêtes non-critiques
4. Augmentation d'urgence de quota si nécessaire

#### Rotation des Clés
```bash
# Génération nouvelle clé via l'API OpenAI
NEW_KEY=$(curl -s -X POST https://api.openai.com/v1/api-keys \
  -H "Authorization: Bearer $MASTER_KEY" \
  -H "Content-Type: application/json" \
  -d '{"name": "PhotoListing-Prod-'$(date +%Y%m%d)'"}' | jq -r '.key')

# Mise à jour dans le gestionnaire de secrets
gcloud secrets versions add openai-api-key --data-file=- <<< "$NEW_KEY"

# Redéploiement progressif des services
kubectl rollout restart deployment/photolisting-api-processor
```

### 5.2 Services Cloud (GCP/AWS)

#### Monitoring des Coûts
- Budgets par service avec alertes
- Revue hebdomadaire des coûts anormaux
- Optimisation mensuelle (instances réservées, etc.)

#### Gestion des Accès
- Principe du moindre privilège
- Rotation des comptes de service tous les 90 jours
- Audit trimestriel des IAM policies

### 5.3 Services de Paiement

#### Surveillance des Transactions
- Alertes sur taux d'erreur > 5%
- Vérification quotidienne des transactions en suspens
- Réconciliation hebdomadaire

#### Procédure en Cas de Défaillance
1. Basculement vers le provider de paiement secondaire
2. Communication aux utilisateurs affectés
3. Suivi manuel des transactions en échec
4. Coordination avec le support du service de paiement

## 6. Sécurité Opérationnelle

### 6.1 Gestion des Accès

#### Principes
- Accès basé sur les rôles (RBAC)
- Authentification multi-facteurs pour tous les accès admin
- Sessions limitées à 8 heures
- Politique de mots de passe forts

#### Matrice d'Accès

| Rôle | Prod DB | Prod API | Staging | Logs | Monitoring |
|------|---------|----------|---------|------|------------|
| CTO | CRUD | CRUD | CRUD | READ | CRUD |
| Lead Developer | READ | CRUD | CRUD | READ | CRUD |
| Developer | - | - | CRUD | READ | READ |
| DevOps | READ | CRUD | CRUD | READ | CRUD |
| Support | - | - | READ | READ | READ |

### 6.2 Gestion des Secrets

- Utilisation de Google Secret Manager / AWS KMS
- Pas de secrets dans le code ou les variables d'environnement
- Rotation automatique selon calendrier
- Accès aux secrets tracé et audité

### 6.3 Scan de Vulnérabilités

- Scan quotidien des images docker
- Analyse de dépendances dans la CI/CD
- Scan hebdomadaire de l'infrastructure
- Pentest externe trimestriel

### 6.4 Réponse aux Incidents de Sécurité

1. **Détection**
   - Alertes automatisées (SIEM)
   - Rapports de vulnérabilités

2. **Confinement**
   - Isolation des systèmes compromis
   - Blocage des accès suspects

3. **Éradication**
   - Identification et correction de la vulnérabilité
   - Suppression des artefacts malveillants

4. **Récupération**
   - Restauration des systèmes propres
   - Validation de la sécurité

5. **Leçons**
   - Rapport d'incident détaillé
   - Mise à jour des procédures

## 7. Gestion de Capacité

### 7.1 Surveillance des Ressources

#### Métriques Clés
- CPU: Alerte à 70% soutenu
- Mémoire: Alerte à 85% soutenu
- Stockage: Alerte à 75% utilisé
- Bande passante: Alerte à 70% du provisionnement

#### Outils
- Datadog pour les métriques système
- Grafana pour dashboards opérationnels
- New Relic pour APM

### 7.2 Scaling Automatique

| Service | Métrique déclencheur | Scale-out | Scale-in | Min | Max |
|---------|----------------------|-----------|----------|-----|-----|
| API Servers | CPU > 60% pendant 3min | +2 instances | -1 après 15min < 40% | 3 | 15 |
| Workers | Queue depth > 100 | +2 instances | -1 après 10min idle | 2 | 20 |
| Database | Connexions > 80% | Upgrade tier | - | - | - |

### 7.3 Planification de Capacité

- Révision mensuelle des tendances d'utilisation
- Projection trimestrielle des besoins
- Planning de scaling pour événements marketing majeurs

```python
# Exemple de script de prévision de capacité
def forecast_capacity(current_usage, growth_rate, months):
    """
    Forecast capacity requirements based on current usage and growth rate
    """
    projections = []
    for i in range(months):
        next_month = current_usage * (1 + growth_rate) ** (i+1)
        projections.append({
            'month': i+1,
            'projected_usage': next_month,
            'recommended_capacity': next_month * 1.3  # 30% headroom
        })
    return projections
```

## 8. Documentation et Procédures

### 8.1 Inventaire des Procédures

| Procédure | Localisation | Dernière MAJ | Responsable |
|-----------|--------------|--------------|-------------|
| Déploiement Backend | [Lien](#) | 2023-02-15 | DevOps |
| Recovery Plan | [Lien](#) | 2023-04-10 | Lead Dev |
| Scaling Manuel | [Lien](#) | 2023-03-22 | DevOps |
| Rotation Certificats | [Lien](#) | 2023-05-05 | Security |
| Gestion des Backups | [Lien](#) | 2023-01-30 | DBA |

### 8.2 Mises à Jour de la Documentation

- Révision après chaque changement majeur d'infrastructure
- Revue complète trimestrielle
- Tests de procédures critiques semestriels
- Historique des modifications conservé

### 8.3 Onboarding Opérationnel

Programme d'intégration pour nouveaux membres:
1. Accès environnements non-production
2. Formation surveillance et alertes
3. Shadowing des procédures courantes
4. Test des procédures en environnement sandbox
5. Certification interne avant accès production

## 9. Continuité d'Activité et Reprise après Sinistre

### 9.1 Stratégie de Continuité

#### Objectifs
- RTO (Recovery Time Objective): 2 heures
- RPO (Recovery Point Objective): 15 minutes
- Disponibilité cible: 99.95% (4h22min d'indisponibilité/an)

#### Architecture Multi-Région
- Services primaires: europe-west1
- Services de secours: europe-west3
- Réplication synchrone des données critiques
- CDN multi-région par défaut

### 9.2 Scénarios de Reprise

#### Défaillance Zone
1. Activation du scaling compensatoire dans les zones actives
2. Vérification de la réplication des données
3. Ajustement des load balancers

#### Défaillance Région
1. Promotion de la région secondaire en primaire
2. Redirection du trafic via DNS/Load Balancers
3. Scaling des ressources dans la région secondaire
4. Validation des données et synchronisation

#### Défaillance Provider Cloud
1. Activation du plan de continuité inter-cloud
2. Restauration des backups cross-cloud
3. Redirection du trafic via DNS global
4. Communication de crise aux utilisateurs

### 9.3 Tests de Reprise

#### Programme de Tests
- Test de basculement de zone: Mensuel
- Test de basculement de région: Trimestriel
- Test de reprise complète: Semestriel

#### Procédure de Test
1. Notification aux parties prenantes
2. Préparation des checkpoints de validation
3. Exécution du test selon runbook
4. Validation technique et fonctionnelle
5. Mesure des temps de reprise
6. Documentation des résultats et améliorations

## 10. Automatisation et Amélioration Continue

### 10.1 Stratégie d'Automatisation

- Priorisation selon fréquence et risque d'erreur
- Infrastructure as Code pour tous les environnements
- Runbooks automatisés pour les opérations courantes
- Tests automatisés pour les procédures critiques

### 10.2 Outils d'Automatisation

| Catégorie | Outils | Usage |
|-----------|--------|-------|
| IaC | Terraform, Cloud Formation | Provisionnement infrastructure |
| Configuration | Ansible, Chef | Configuration des serveurs |
| Containers | Docker, Kubernetes | Orchestration des services |
| CI/CD | GitHub Actions, Bitrise | Pipelines de déploiement |
| Monitoring | Prometheus, Grafana | Métriques et alertes |
| Automatisation | Python, Bash, Go | Scripts personnalisés |

### 10.3 KPIs Opérationnels

| Métrique | Cible | Mesure | Fréquence |
|----------|-------|--------|-----------|
| MTTR (Mean Time to Resolve) | < 2h | Temps moyen résolution incident | Mensuel |
| Change Success Rate | > 95% | % déploiements sans incident | Hebdomadaire |
| Automation Coverage | > 85% | % tâches automatisées | Trimestriel |
| Alert Noise Ratio | < 10% | % alertes sans action requise | Mensuel |
| SLA Compliance | > 99.9% | % respect des SLAs | Mensuel |

### 10.4 Processus d'Amélioration

- Revues post-incident systématiques
- Réunion opérationnelle hebdomadaire
- Audit trimestriel des procédures
- Programme de réduction de la dette technique

## Annexes

### A. Contacts et Escalade

| Rôle | Nom | Contact Primaire | Contact Secondaire | Horaires |
|------|-----|------------------|---------------------|----------|
| Astreinte N1 | Rotation | +33 6 12 34 56 78 | ops@photolisting.app | 24/7 |
| Lead DevOps | Jean Dupont | +33 6 23 45 67 89 | jean.d@photolisting.app | 9h-18h |
| Lead Developer | Marie Martin | +33 6 34 56 78 90 | marie.m@photolisting.app | 9h-18h |
| CTO | Marc Lambert | +33 6 45 67 89 01 | marc.l@photolisting.app | 9h-19h |
| Support OpenAI | - | - | support@openai.com | - |
| Support GCP | - | - | via console | 24/7 |

### B. Inventaire des Services

| Service | Environnement | URL | Repository | Responsable |
|---------|---------------|-----|------------|-------------|
| API Gateway | Production | https://api.photolisting.app | github.com/photolisting/api-gateway | Team Backend |
| Processing Service | Production | https://process.photolisting.app | github.com/photolisting/processing | Team ML |
| User Service | Production | https://users.photolisting.app | github.com/photolisting/users | Team Backend |
| Frontend Web | Production | https://www.photolisting.app | github.com/photolisting/web | Team Frontend |
| Mobile Android | Production | com.photolisting.app | github.com/photolisting/android | Team Mobile |
| Mobile iOS | Production | id1234567890 | github.com/photolisting/ios | Team Mobile |

### C. Modèles de Scripts Opérationnels

#### Verification de Santé API
```bash
#!/bin/bash
# health_check.sh - Vérifie la santé des endpoints API

ENDPOINTS=(
  "https://api.photolisting.app/health"
  "https://process.photolisting.app/health"
  "https://users.photolisting.app/health"
)

for endpoint in "${ENDPOINTS[@]}"; do
  echo "Checking $endpoint..."
  response=$(curl -s -o /dev/null -w "%{http_code}" "$endpoint")
  
  if [ "$response" == "200" ]; then
    echo "✅ $endpoint is healthy"
  else
    echo "❌ $endpoint returned $response"
    # Notify if needed
    # send_alert "$endpoint returned $response"
  fi
done
```

#### Rotation des Logs
```bash
#!/bin/bash
# rotate_logs.sh - Archive et compresse les logs anciens

LOG_DIR="/var/log/photolisting"
ARCHIVE_DIR="/var/archives/logs"
RETENTION_DAYS=90

# Create archive directory if it doesn't exist
mkdir -p "$ARCHIVE_DIR"

# Archive logs older than 7 days
find "$LOG_DIR" -name "*.log" -type f -mtime +7 | while read logfile; do
  basename=$(basename "$logfile")
  archive_name="${ARCHIVE_DIR}/${basename%.*}_$(date -r "$logfile" +%Y%m%d).tar.gz"
  
  echo "Archiving $logfile to $archive_name"
  tar -czf "$archive_name" "$logfile" && rm "$logfile"
done

# Delete archives older than retention period
find "$ARCHIVE_DIR" -name "*.tar.gz" -type f -mtime +$RETENTION_DAYS -delete
```

### D. Plan de Capacité Actuel

| Ressource | Utilisation Actuelle | Capacité Totale | Projection 6 mois | Action Recommandée |
|-----------|----------------------|-----------------|-------------------|-------------------|
| API Servers | 45% CPU, 60% RAM | 10 instances | 70% CPU, 80% RAM | Augmenter à 15 instances à M+3 |
| Database | 500GB, 2000 IOPS | 1TB, 3000 IOPS | 800GB, 2800 IOPS | Prévoir upgrade à M+4 |
| Storage | 5TB, 70% tier chaud | 10TB | 8TB, 65% tier chaud | RAS, suivre tendance |
| Réseau | 100Mbps moyen, 350Mbps pic | 1Gbps | 200Mbps moyen, 600Mbps pic | Optimisation CDN pour M+2 |
| OpenAI API | $3,200/mois | $5,000/mois | $4,800/mois | Négocier augmentation quota à M+3 |